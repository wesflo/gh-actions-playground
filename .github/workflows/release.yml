name: Release (labels -> version)

on:
  push:
    branches: ["main"]

permissions:
  contents: write
  packages: write
  pull-requests: read
  id-token: write   # wichtig für AWS OIDC (kann auch job-level gesetzt werden)

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  test:
    if: ${{ github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, 'chore(release):') }}
    uses: wesflo/gh-actions-workflows/.github/workflows/test.yml@main
    with:
      workdir: ${{ vars.WORKDIR || '.' }}
      node_version: ${{ vars.NODE_VERSION || '20' }}
      test_command: "npm run test:c"

  build-lib:
    uses: wesflo/gh-actions-workflows/.github/workflows/build.yml@main
    with:
      workdir: ${{ vars.WORKDIR || '.' }}
      node_version: ${{ vars.NODE_VERSION || '20' }}
      build_command: "npm run build"
      upload_artifacts: true
      artifact_name: "dist-lib"

  build-iife:
    uses: wesflo/gh-actions-workflows/.github/workflows/build.yml@main
    with:
      workdir: ${{ vars.WORKDIR || '.' }}
      node_version: ${{ vars.NODE_VERSION || '20' }}
      build_command: "npm run build:iife"
      upload_artifacts: true
      artifact_name: "dist-iife"

  deploy-preprod:
    name: Deploy preprod (S3)
    needs: [test, build-iife]
    environment: preprod
    uses: wesflo/gh-actions-workflows/.github/workflows/deploy-s3.yml@main
    with:
      artifact_name: "dist-iife"
      dist_dir: "dist"
      bucket: "wesflo-preprod-demo"
      region: ${{ vars.AWS_REGION || 'eu-central-1' }}
      cache_control: "public,max-age=300"
    secrets:
      aws_role_arn: ${{ secrets.AWS_ROLE_ARN_PREPROD }}

  deploy-prod:
    name: Deploy prod (S3)
    needs: [deploy-preprod]
    environment: prod
    uses: wesflo/gh-actions-workflows/.github/workflows/deploy-s3.yml@main
    with:
      artifact_name: "dist-iife"
      dist_dir: "dist"
      bucket: "wesflo-prod-demo"
      region: ${{ vars.AWS_REGION || 'eu-central-1' }}
      cache_control: "public,max-age=3600"
    secrets:
      aws_role_arn: ${{ secrets.AWS_ROLE_ARN_PROD }}

  publish:
    name: Publish to Registry
    needs: [test, build-lib]
    uses: wesflo/gh-actions-workflows/.github/workflows/publish.yml@main
    with:
      workdir: ${{ vars.WORKDIR || '.' }}
      node_version: ${{ vars.NODE_VERSION || '20' }}
      npm_scope: ${{ vars.NPM_SCOPE || '@wesflo' }}
      npm_registry: ${{ vars.NPM_REGISTRY || 'https://npm.pkg.github.com' }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  activate-release:
    name: Activate release (write DB version)
    needs: [deploy-prod]
    environment: prod-db   # separates Gate
    runs-on: ubuntu-latest
    steps:
      - name: Call release activation API
        run: |
          echo "Hier wäre dann das CB getriggert"
#          curl -X POST "${{ secrets.RELEASE_API_URL }}" \
#            -H "Authorization: Bearer ${{ secrets.RELEASE_API_TOKEN }}" \
#            -H "Content-Type: application/json" \
#            -d '{"version":"${{ github.ref_name }}","app":"my-app"}'